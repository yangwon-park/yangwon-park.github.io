---
layout: single
title: Trouble Shooting 기록 03. JPA Hibernate, QueryDSL 그리고 Spatial DB
tag: [java, spring, web, AWS, Trouble Shooting]
toc: true 
author_profile: false
sidebar:
    nav: "docs"
---

<br/>

# 읽기에 앞서

- 이 게시글은 Spatial DB 자체에 대하여 심도있게 공부하고자 정리하는 목적이 아닌 구글링을 통해서 얻을 수 있는 정보가 많이 없고 오래된 경우가 허다하여 직접 Spatial Data를 사용하기 위하여 공부하고 알게 된 것들을 정리하는 목적임을 미리 알려드립니다.

- Dependency Tree 보는 법

- <p align="center"><img src="https://user-images.githubusercontent.com/97505799/203046888-e8f05d3b-1b14-4067-be0c-5421d27568a9.PNG" alt="dependency tress" width="50%"></p>

## 개발 환경

- JPA Hibernate 5.6.5
- QueryDSL 5.0.0
- MariaDB 10.6.10
- 빌드 관리 도구 : Gradle



# Spatial DB란?

- ***[위키피디아 링크](https://en.wikipedia.org/wiki/Spatial_database)***
- Spatial DB, 우리 말로 공간 DB란 **공간 데이터**를 다루기 위한 특수 목적으로 사용되는 DB
- 목적
  - 좌표계로 표현할 수 있는 공간 객체들을 데이터화하여 보다 쉽게 저장하기 위함.
  - 저장한 공간 데이터에 손쉬운 연산을 수행하기 위함.

- 흔히 접할 수 있는 RDBMS에 공간 데이터를 다루기 위한 기능들이 탑재되어 있음.

## 공간 데이터 타입

- 출처 : ***[참고 블로그](https://sparkdia.tistory.com/24)***

- 자주 사용되는 공간 데이터 타입

- <p align="center"><img src="https://user-images.githubusercontent.com/97505799/202889336-40978b30-3165-460f-8ec7-27c4ab60f14c.png" alt="공간 데이터 타입" width="100%"></p>

- | **공간 데이터 타입** | **정의**                                                     | **SQL 예**                                                   |
  | :------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
  | Point                | 좌표 공간 한 지점의 위치 (위도, 경도)                        | POINT(10 10)                                                 |
  | LineString           | 다수의 Point를 연결해주는 선분                               | LINESTRING(10 10, 20 20, 30 30)                              |
  | Polygon              | 다수의 선분들이 연결되어 닫혀 있는 다각형<br />각각의 Point의 처음과 끝은 같은 좌표를 공유해야 하며<br /> Polygon 전체에서 처음과 끝은 같은 Point로 이루어져야 함 | POLYGON((10 10, 10 20, 20 20, 20, 10, 10 10))                |
  | Multi-Point          | 다수의 Point 집합                                            | MULTIPOINT(10 10, 30 20)                                     |
  | Multi-LineString     | 다수의 LineString 집합                                       | MULTILINESTRING((10 10, 20 20), (20 15, 30 40))              |
  | Mulit-Polygon        | 다수의 Polygon 집합                                          | MULTIPOLYGON ((( 10 10, 15 10, 20 15, 20 25, 15 20, 10 10 )) , (( 40 25, 50 40, 35 35, 25 10, 40 25 )) ) |
  | GeomCollection       | 모든 공간 데이터들의 집합                                    | GEOMETRYCOLLECTION ( POINT (10 10), LINESTRING (20 20, 30 40), POINT (30 15) ) |

## 공간 관계 함수

- 출처 : ***[참고 블로그](https://sparkdia.tistory.com/25)***

- 두 공간 객체 간의 관계를 일반 데이터 타입으로 반환해주는 함수 (Boolean 또는 Number)

- MySQL에서 제공해주는 공간 관계 함수 중 자주 사용되는 함수들

- <p align="center"><img src="https://user-images.githubusercontent.com/97505799/202889704-6167a808-4531-47f5-9db9-fcebd0660d44.png" alt="공간 관계 함수" width="100%"></p>

- | **공간 관계 함수**                                   | **설명**                                                     |
  | :--------------------------------------------------- | :----------------------------------------------------------- |
  | ST_Equals (g1 Geometry, g2 Geometry)  : Boolean      | g1과 g2가 동일하면 True를 반환하고 상이하다면 False를 반환   |
  | ST_Disjoint (g1 Geometry, g2 Geometry)    : Boolean  | g1과 g2가 겹치는 곳 없다면 True를 반환하고, 겹치는 곳이 있으면 False를 반환 |
  | ST_Within (g1 Geometry, g2 Geometry)  : Boolean      | g1가 g2 영역 안에 포함된 경우 True를 반환하고 그렇지 않은 경우 False를 반환 (Contains와 반대) |
  | ST_Overlaps (g1 Geometry, g2 Geometry)   : Boolean   | g1과 g2 영역 중 교집합 영역이 존재하는 경우 True를 반환하고 존재하지 않는 경우 False를 반환 |
  | ST_Intersects (g1 Geometry, g2 Geometry)   : Boolean | g1과 g2 영역 간에 교집합이 존재하는 경우 True를 반환하고 그렇지 않은 경우 False를 반환 |
  | ST_Contains (g1 Geometry, g2 Geometry)  : Boolean    | g2가 g1 영역 안에 포함된 경우 True를 반환하고 그렇지 않은 경우 False를 반환 (Within과 반대) |
  | ST_Touches (g1 Geometry, g2 Geometry)  : Boolean     | g1과 g2가 경계 영역에서만 겹치는 경우 결과 값으로 True를 반환하며 경계 영역 외에서 겹치거나 겹치는 곳이 없다면 False를 반환 |
  | ST_Distance (g1 Geometry, g2 Geometry)  : Double     | g1과 g2간의 거리를 반환                                      |

## 공간 연산 함수

- 출처 - ***[참고 블로그](https://sparkdia.tistory.com/26)***

- 두 공간 객체의 연산 결과를 **새로운 공간 객체**로 반환해주는 함수

- MySQL에서 제공해주는 공간 연산 함수 중 자주 사용되는 함수들

- <p align="center"><img src="https://user-images.githubusercontent.com/97505799/202889832-570df40c-2a39-4911-a282-d59ef3d11992.png" alt="공간 관계 함수" width="100%"></p>

- | **공간 연산 함수**                                     | **설명**                                  |
  | ------------------------------------------------------ | ----------------------------------------- |
  | ST_Intersection (g1 Geometry, g2 Geometry)  : Geometry | g1과 g2의 교집합인 공간 객체를 반환       |
  | ST_Union (g1 Geometry, g2 Geometry)  : Geometry        | g1과 g2의 합집합인 공간 객체를 반환       |
  | ST_Difference (g1 Geometry, g2 Geometry)  : Geometry   | g1과 g2의 차집합인 공간 객체를 반환       |
  | ST_Buffer (g1 Geometry, d Double )  : Geometry         | g1에서 d 거리만큼 확장된 공간 객체를 반환 |
  | ST_Envelope (g1 Geometry)  : Polygon                   | g1을 포함하는 최소 MBR인 Polygon을 반환   |
  | ST_StartPoint (l1 LineString)  : Point                 | l1의 첫 번째 Point를 반환                 |
  | ST_EndPoint (l1 LineString)  : Point                   | l1의 마지막 Point를 반환                  |
  | ST_PointN (l1 LineString)  : Point                     | l1의 n 번째 Point를 반환                  |

<br>

# JPA Hibernate와 Spatial Data

- ***[Hibernate Spatial 공식 문서](https://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#spatial)***

- 공식 문서에 따르면 Hibernate 5.0에 들어서야 정식 Hibernate ORM Project로 소속되었다고 함.

- Hibernate에서 Spatial Data를 사용하려면 **org.hibernate:hibernate-core** 의존성 외에 아래처럼 별도의 의존성을 추가해줘야만 한다.

- <p align="center"><img src="https://user-images.githubusercontent.com/97505799/203054915-36a074b9-6b63-48ac-b6d2-e508086045c4.PNG" alt="hibernate spatial dependency" width="100%"></p>

- 아래 트리와 같이 라이브러리들이 주입되는데 이 중 유의깊게 봐야할 것들은 총 3개가 있다.

- <p align="center"><img src="https://user-images.githubusercontent.com/97505799/203046413-f4f89d36-de9c-43cd-81cd-5103a4d5a27c.PNG" alt="hibernate spatial dependency tree" width="100%"></p>

- **org.hibernate:hibernate-core**

  - hibernate spatial 핵심 기능들이 들어있음

- **org.geolatte:geolatte-geom**, **org.locationtech.jts:jts-core**

  - hibernate spatial에서 지원하는 Geometry Model

- 그 밖에 log 관련 라이브러리와 PostgreSQL 라이브러리가 들어오는데, PostgreSql 라이브러리가 굳이 왜 같이 들어오는지 잘 모르겠다.

- 위의 사진을 보면, jts 의존성 주입 부분을 주석 처리 해놓은 것을 볼 수 있는데, 이는 hibernate spatial에 대해서 하나도 모르고 구글링으로 찾은 관련된 라이브러리를 다 받아서 사용해보던 중 org.locationtech.jts 라이브러리를 별도로 추가해야만 사용할 수 있다고 착각한 흔적이다. (hibernate 5.2 이전 버전까지는 별도로 추가했어야 되는 것 같긴 한데 정확히는 잘 모르겠음. 만약 자신이 사용하는 hibernate 버전이 5.6.5가 아니라면 나처럼 Dependency Tree를 확인하여 함께 설치되었는지 꼭 확인해보자.)

## JTS vs Geolatte

- 앞서 살펴봤다 싶이 hibernate spatial 라이브러리를 추가하면 2개의 공간 데이터 타입을 지원해주는 라이브러리가 별도로 들어온다. 이에 대해서 알아보자.

### 그전에 잠깐!

- 구글링을 하다보면 작성된지 좀 지난 문서의 경우 jts의 패키지 경로가 org.locationtech.jts.geom이 아닌 com.vividsolutions.jts.geom인 경우가 있다.
- 아래 링크에서 확인할 수 있듯이 vividsolutions이 이전 버전의 산물이고 2016년 11월 3일 기준으로 the Eclipse Location Tech working group으로 이관(?)되어 개발되고 있다고 한다. 이로 인해 이관일 이후에 배포된 라이브러리 패키지명 또한 함께 바뀐 것이다.
- 2022년 11월인 작성일 기준에서 vividsolutions 시절 기능을 사용할 일은 없다고 판단하므로 hibernate spatial 라이브러리만 추가했을 때 별도의 Geometry Type이 함께 추가되지 않는다면 org.locationtech.jts.geom을 받아서 설치하면 될 것 같다.
- ***[참고 링크 - Difference in JTS from vividsolutions and locationtech](https://gis.stackexchange.com/questions/246588/difference-in-jts-from-vivid-solution-and-locationtech)***

### JTS

- Spatial data types are not part of the Java standard library, and they are absent from the JDBC specification. Over the years [JTS](http://tsusiatsoftware.net/jts/main.html) has emerged the *de facto* standard to fill this gap. - 공식 문서
- 공식 문서에서 보면 알 수 있듯이, JTS는 사실상 Spatial data type의 `표준`이다.

### Geolatte-geom

- Geolatte-geom (also written by the lead developer of Hibernate Spatial) is a more recent library that supports many features specified in SQL/MM but not available in JTS (such as support for 4D geometries, and support for extended WKT/WKB formats). Geolatte-geom also implements encoders/decoders for the database native types. Geolatte-geom has good interoperability with JTS. Converting a Geolatte `geometry` to a JTS `geometry, for instance, doesn’t require copying of the coordinates. It also delegates spatial processing to JTS. - 공식 문서
- Geolatte-geom 또한 마찬가지로 Hibernate Spatial 쪽에서 개발한 것이며, JTS에 비하여 더 최신 라이브러리이기에 보다 더 많은 기능을 지원한다고 나와있다.







